# Position Management Service

Event-Sourced Position Management Service with Hotpath/Coldpath Architecture for processing 2M trades/day.

## Architecture

- **Hotpath**: Low-latency (<100ms p99) synchronous processing for current/forward-dated trades
- **Coldpath**: Asynchronous processing for backdated trades with full event stream replay
- **Event Sourcing**: Append-only event store with version-based optimistic locking
- **Snapshot Pattern**: Hot cache for fast state reconstruction

## Technology Stack

- **Framework**: Spring Boot 3.2.0
- **Database**: PostgreSQL (partitioned event store) or MS SQL Server (configurable)
- **Cache**: Redis or Caffeine (configurable)
- **Messaging**: Apache Kafka or Solace (configurable)
- **Schema Registry**: Confluent Schema Registry (Avro)
- **Resilience**: Resilience4j (Circuit breakers, retries, timeouts)
- **Observability**: OpenTelemetry, Micrometer, Prometheus
- **Build Tool**: Maven

## Project Structure

```
position-management-service/
├── domain/          # Core business logic and domain models
├── infrastructure/  # Database, Kafka, external integrations
├── application/     # Service layer and orchestration
└── api/            # REST endpoints and API layer
```

## Getting Started

### Prerequisites

- Java 17+
- Maven 3.8+
- **Database**: PostgreSQL 14+ OR MS SQL Server 2019+ (configurable)
- Redis 6+ (optional, can use in-memory cache)
- Kafka 3.5+ (optional, can use Solace)
- Confluent Schema Registry (optional)

### Running the Application

#### With PostgreSQL (Default)

1. Start infrastructure services (PostgreSQL, Redis, Kafka)
2. Configure `application.yml` with connection details
3. Run migrations: Flyway will auto-migrate on startup
4. Start the application:
   ```bash
   mvn spring-boot:run -pl api
   ```

#### With MS SQL Server

1. Start MS SQL Server instance
2. Set environment variables:
   ```bash
   export DB_TYPE=sqlserver
   export DB_HOST=localhost
   export DB_PORT=1433
   export DB_NAME=equity_swap_db
   export DB_USERNAME=SA
   export DB_PASSWORD=YourPassword
   ```
3. Start the application:
   ```bash
   mvn spring-boot:run -pl api
   ```

### Environment Variables

**Database Configuration:**
- `DB_TYPE`: Database type (`postgresql` or `sqlserver`, default: `postgresql`)
- `DB_HOST`: Database host (default: `localhost`)
- `DB_PORT`: Database port (PostgreSQL: `5432`, MS SQL Server: `1433`)
- `DB_NAME`: Database name (default: `equity_swap_db`)
- `DB_USERNAME`: Database username
- `DB_PASSWORD`: Database password
- `DB_URL`: Optional full JDBC URL (overrides host/port/name)

**Infrastructure:**
- `REDIS_HOST`: Redis host (default: `localhost`)
- `REDIS_PORT`: Redis port (default: `6379`)
- `KAFKA_BOOTSTRAP_SERVERS`: Kafka brokers (default: `localhost:9092`)
- `SCHEMA_REGISTRY_URL`: Schema Registry URL (default: `http://localhost:8081`)
- `ENVIRONMENT`: Environment name (local, dev, prod)

**Application Configuration:**
- `MESSAGING_TYPE`: Messaging type (`kafka` or `solace`, default: `kafka`)
- `CACHE_TYPE`: Cache type (`redis` or `memory`, default: `redis`)
- `CONTRACT_SERVICE_TYPE`: Contract service type (`rest` or `mock`, default: `mock`)

## Development

### Building

```bash
mvn clean install
```

### Testing

```bash
mvn test
```

## Documentation

- **Features**: See `documents/FEATURES.md` for comprehensive list of implemented features
- **Implementation Plan**: See `documents/IMPLEMENTATION_PLAN.md` for detailed implementation plan
- **Database Configuration**: See `documents/DATABASE_CONFIGURATION.md` for database setup
- **MS SQL Server Setup**: See `documents/SQL_SERVER_SETUP_GUIDE.md` for SQL Server setup guide
- **Architecture**: See `documents/hotpath-coldpath-architecture.md` for architecture details

## License

Proprietary - Bank Internal Use Only
